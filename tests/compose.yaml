services:

  localstack-ui-app:
    build:
      context: .. # Project root directory
      dockerfile: ./docker/app/Dockerfile
    volumes:
      # Mount source code for live reload
      - ../src:/app/src
      - ../static:/app/static
      - ../templates:/app/templates
      - ../pyproject.toml:/app/pyproject.toml
    environment:
      - OAUTH_PROVIDER=mock
      - MOCK_OAUTH_URL=http://mock-oauth:8080
      - BASE_URL=https://localstack-ui-nginx
    # Command to run the application, ensuring it listens on all interfaces
    # and uses the standard port 8000.
    command: uvicorn src.food_diary.main:app --host 0.0.0.0 --port 8000 --log-level error
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 1s
      timeout: 1s
      retries: 5
      start_period: 1s
    networks:
      - food_diary_test_network

  localstack-ui-nginx:
    build:
      context: ..
      dockerfile: ./docker/nginx/Dockerfile
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      mock-oauth:
        condition: service_healthy
      localstack-ui-app:
        condition: service_healthy
    networks:
      - food_diary_test_network

  localstack-ui-playwright:
    build:
      context: ..
      dockerfile: ./docker/playwright/Dockerfile
    depends_on:
      - localstack-ui-nginx
    networks:
      - food_diary_test_network
    volumes:
      - ../tests:/tests
    working_dir: /tests
    environment:
      - BASE_URL=https://localstack-ui-nginx
    platform: linux/amd64 # Force compatibility
    command: ["python", "e2e/test_app.py"]

networks:
  food_diary_test_network:
    driver: bridge
