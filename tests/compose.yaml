services:
  localstack-ui:
    build:
      context: .. # Project root directory
      dockerfile: ./docker/app/Dockerfile
    volumes:
      # Mount source code for live reload
      - ../src:/app/src
      - ../static:/app/static
      - ../templates:/app/templates
      - ../pyproject.toml:/app/pyproject.toml
    environment:
      - BASE_URL=https://localstack-ui-nginx
      - LOCALSTACK_ENDPOINT=http://localstack-ui-localstack:4566
    command: uvicorn src.localstack_ui.main:app --host 0.0.0.0 --port 8000 --log-level error
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 1s
      timeout: 1s
      retries: 5
      start_period: 1s
    depends_on:
      localstack-ui-localstack:
        condition: service_healthy
    networks:
      - localstack_ui_test_network

  localstack-ui-localstack:
    build:
      context: ..
      dockerfile: ./docker/localstack/Dockerfile
    container_name: localstack-ui-localstack-test
    environment:
      - SERVICES=s3,lambda,stepfunctions
      - DEBUG=1
      - DATA_DIR=/tmp/localstack/data
      - LAMBDA_EXECUTOR=local
    volumes:
      - "../docker/localstack/init:/etc/localstack/init/ready.d"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - localstack_ui_test_network

  localstack-ui-nginx:
    build:
      context: ..
      dockerfile: ./docker/nginx/Dockerfile
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ../docker/nginx/nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      localstack-ui:
        condition: service_healthy
    networks:
      - localstack_ui_test_network

  localstack-ui-playwright:
    build:
      context: ..
      dockerfile: ./docker/playwright/Dockerfile
    depends_on:
      - localstack-ui-nginx
    networks:
      - localstack_ui_test_network
    volumes:
      - ../tests:/tests
    working_dir: /tests
    environment:
      - BASE_URL=https://localstack-ui-nginx
    platform: linux/amd64 # Force compatibility
    command: ["python", "e2e/test_app.py"]

networks:
  localstack_ui_test_network:
    driver: bridge
