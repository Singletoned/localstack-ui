{% extends "base.html" %}

{% block title %}Upload File to {{ bucket_name }} - LocalStack UI{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="{{ url_for('home') }}">Home</a></li>
            <li><a href="{{ url_for('s3_buckets') }}">S3 Buckets</a></li>
            <li><a href="{{ url_for('s3_bucket_contents', bucket_name=bucket_name) }}">{{ bucket_name }}</a></li>
            <li class="is-active"><a href="#" aria-current="page">Upload File</a></li>
        </ul>
    </nav>

    <div class="level">
        <div class="level-left">
            <div class="level-item">
                <h1 class="title">
                    <i class="fas fa-upload"></i>&nbsp;Upload File to {{ bucket_name }}
                </h1>
            </div>
        </div>
    </div>

    {% if error_message %}
    <div class="notification is-danger">
        <button class="delete"></button>
        <strong>Error:</strong> {{ error_message }}
    </div>
    {% endif %}

    <div class="columns">
        <div class="column is-two-thirds">
            <div class="box">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    <div class="field">
                        <label class="label">Select File</label>
                        <div class="control">
                            <div class="file is-boxed has-name is-fullwidth" id="fileInput">
                                <label class="file-label">
                                    <input class="file-input" type="file" name="file" id="file" required>
                                    <span class="file-cta">
                                        <span class="file-icon">
                                            <i class="fas fa-upload"></i>
                                        </span>
                                        <span class="file-label">
                                            Choose a file...
                                        </span>
                                    </span>
                                    <span class="file-name" id="fileName">
                                        No file selected
                                    </span>
                                </label>
                            </div>
                        </div>
                        <p class="help">
                            Maximum file size: <strong>1MB</strong>. 
                            Supported formats: Any file type is allowed.
                        </p>
                    </div>

                    <div class="field" id="fileInfo" style="display: none;">
                        <div class="notification is-light">
                            <strong>File Details:</strong>
                            <ul>
                                <li>Name: <span id="fileNameDetail"></span></li>
                                <li>Size: <span id="fileSizeDetail"></span></li>
                                <li>Type: <span id="fileTypeDetail"></span></li>
                            </ul>
                        </div>
                    </div>

                    <div class="field is-grouped">
                        <div class="control">
                            <button type="submit" class="button is-primary" id="uploadButton" disabled>
                                <span class="icon">
                                    <i class="fas fa-upload"></i>
                                </span>
                                <span>Upload File</span>
                            </button>
                        </div>
                        <div class="control">
                            <a href="{{ url_for('s3_bucket_contents', bucket_name=bucket_name) }}" class="button is-light">
                                Cancel
                            </a>
                        </div>
                    </div>
                </form>

                <div id="uploadProgress" class="is-hidden">
                    <progress class="progress is-primary" max="100">0%</progress>
                    <p class="has-text-centered">Uploading file...</p>
                </div>
            </div>
        </div>

        <div class="column is-one-third">
            <div class="notification is-info">
                <h5 class="title is-5">Upload Guidelines</h5>
                <div class="content">
                    <ul>
                        <li>Files must be under 1MB in size</li>
                        <li>All file types are supported</li>
                        <li>File names should not contain special characters</li>
                        <li>Existing files with the same name will be overwritten</li>
                    </ul>
                </div>
            </div>

            <div class="notification is-light">
                <h6 class="title is-6">Supported File Types</h6>
                <div class="content">
                    <div class="tags">
                        <span class="tag">Images (PNG, JPG, GIF)</span>
                        <span class="tag">Documents (PDF, TXT, CSV)</span>
                        <span class="tag">Code (JS, CSS, HTML, JSON)</span>
                        <span class="tag">Archives (ZIP, TAR)</span>
                        <span class="tag">And many more...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fileInput = document.getElementById('file');
        const fileName = document.getElementById('fileName');
        const uploadButton = document.getElementById('uploadButton');
        const fileInfo = document.getElementById('fileInfo');
        const uploadForm = document.getElementById('uploadForm');
        const uploadProgress = document.getElementById('uploadProgress');

        // File input change handler
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileName.textContent = file.name;
                uploadButton.disabled = false;

                // Show file details
                document.getElementById('fileNameDetail').textContent = file.name;
                document.getElementById('fileSizeDetail').textContent = formatFileSize(file.size);
                document.getElementById('fileTypeDetail').textContent = file.type || 'Unknown';
                fileInfo.style.display = 'block';

                // Check file size
                const maxSize = 1024 * 1024; // 1MB
                if (file.size > maxSize) {
                    fileName.textContent = `${file.name} (Too large!)`;
                    uploadButton.disabled = true;
                    fileInfo.classList.add('is-danger');
                } else {
                    fileInfo.classList.remove('is-danger');
                }
            } else {
                fileName.textContent = 'No file selected';
                uploadButton.disabled = true;
                fileInfo.style.display = 'none';
            }
        });

        // Form submission handler
        uploadForm.addEventListener('submit', (e) => {
            const file = fileInput.files[0];
            if (file && file.size > 1024 * 1024) {
                e.preventDefault();
                alert('File size exceeds 1MB limit. Please choose a smaller file.');
                return;
            }

            // Show progress
            uploadProgress.classList.remove('is-hidden');
            uploadButton.disabled = true;
        });

        // Auto-hide notifications
        const notifications = document.querySelectorAll('.notification .delete');
        notifications.forEach((deleteButton) => {
            deleteButton.addEventListener('click', () => {
                deleteButton.parentElement.remove();
            });
        });

        // File size formatter
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
    });
</script>
{% endblock %}